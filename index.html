<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offerte Generator 6m</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; margin:20px; }
button { margin:5px; padding:8px 12px; }
.element { border:1px solid #ccc; padding:10px; margin:10px 0; }
img { max-width:100px; margin:5px; }
</style>
</head>
<body>

<h2>Offerte Generator</h2>

<label>Klantnaam:</label>
<input type="text" id="klantNaam"><br><br>

<button onclick="addElement('raam')">Raam toevoegen</button>
<button onclick="addElement('deur')">Deur toevoegen</button>
<button onclick="addElement('poort')">Poort toevoegen</button>

<div id="elementsContainer"></div>

<br>
<button onclick="generatePDF()">PDF downloaden</button>
<button id="mailButton" onclick="sendMail()" disabled>Mail verzenden</button>

<script>

let elements = [];
let pdfBlobGlobal = null;

function addElement(type) {

  const element = {
    id: Date.now(),
    type: type,
    photos: []
  };

  elements.push(element);
  renderElements();
}

function removeElement(id) {
  elements = elements.filter(el => el.id !== id);
  renderElements();
}

function renderElements() {

  const container = document.getElementById("elementsContainer");
  container.innerHTML = "";

  elements.forEach((el, index) => {

    const div = document.createElement("div");
    div.className = "element";

    const title = document.createElement("h4");
    title.innerText = el.type.charAt(0).toUpperCase() + el.type.slice(1) + " " + (index + 1);
    div.appendChild(title);

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.multiple = true;

    fileInput.onchange = function(e) {
      for (let file of e.target.files) {
        el.photos.push(file);
      }
      renderElements();
    };

    div.appendChild(fileInput);

    const photosDiv = document.createElement("div");

    el.photos.forEach(photo => {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(photo);
      photosDiv.appendChild(img);
    });

    div.appendChild(photosDiv);

    const deleteBtn = document.createElement("button");
    deleteBtn.innerText = "Verwijderen";
    deleteBtn.onclick = () => removeElement(el.id);
    div.appendChild(deleteBtn);

    container.appendChild(div);
  });
}

async function generatePDF() {

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;

  // COVER
  doc.setFontSize(22);
  doc.text("Offerte Overzicht", 105, y, null, null, "center");
  y += 15;

  const klant = document.getElementById("klantNaam").value;
  doc.setFontSize(14);
  doc.text("Klant: " + klant, 20, y);
  y += 20;

  // Overzicht
  const counts = {};
  elements.forEach(el => {
    counts[el.type] = (counts[el.type] || 0) + 1;
  });

  doc.setFontSize(12);

  if (counts.raam > 0) {
    doc.text("Aantal ramen: " + counts.raam, 20, y);
    y += 8;
  }

  if (counts.deur > 0) {
    doc.text("Aantal deuren: " + counts.deur, 20, y);
    y += 8;
  }

  if (counts.poort > 0) {
    doc.text("Aantal poorten: " + counts.poort, 20, y);
    y += 8;
  }

  // Nieuwe pagina voor foto's
  doc.addPage();
  y = 20;

  for (let i = 0; i < elements.length; i++) {

    const el = elements[i];

    doc.setFontSize(16);
    doc.text(el.type.toUpperCase() + " " + (i + 1), 20, y);
    y += 10;

    for (let photo of el.photos) {

      const imgData = await fileToBase64(photo);

      const imgProps = doc.getImageProperties(imgData);

      const maxWidth = 90;
      const maxHeight = 60;

      let width = imgProps.width;
      let height = imgProps.height;

      const ratio = Math.min(maxWidth / width, maxHeight / height);
      width *= ratio;
      height *= ratio;

      if (y + height > 270) {
        doc.addPage();
        y = 20;
      }

      doc.addImage(imgData, 'JPEG', 20, y, width, height);
      y += height + 10;
    }

    y += 10;
  }

  pdfBlobGlobal = doc.output("blob");
  doc.save("offerte.pdf");

  document.getElementById("mailButton").disabled = false;
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function sendMail() {

  const formData = new FormData();
  formData.append("pdf", pdfBlobGlobal, "offerte.pdf");
  formData.append("klantNaam", document.getElementById("klantNaam").value);

  elements.forEach((el, i) => {
    el.photos.forEach((photo, j) => {
      formData.append(`photo_${i}_${j}`, photo);
    });
  });

  try {
    await fetch("send_mail.php", {
      method: "POST",
      body: formData
    });

    alert("Mail succesvol verzonden.");

  } catch (error) {
    alert("Fout bij verzenden.");
  }
}

</script>

</body>
</html>
