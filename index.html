<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nieuwe Opmeting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#f4f6f8;}
header{text-align:center;margin-bottom:10px;}
header img{max-width:50px;display:block;margin:0 auto 5px auto;}
h1{font-size:24px;margin:0 0 10px 0;color:rgb(15,36,65);}
button{padding:6px 12px;margin:5px 2px;border:none;border-radius:5px;background:rgb(15,36,65);color:white;cursor:pointer;font-size:14px;}
button:hover:enabled{opacity:0.9;} button:disabled{background:#999;cursor:not-allowed;}
select,input,textarea{width:100%;padding:6px;margin:5px 0;border-radius:5px;border:1px solid #ccc;}
.element{position:relative;background:white;padding:12px;margin-top:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);border-left:6px solid rgb(15,36,65);}
.raam{border-left-color:#2980b9;} .deur{border-left-color:#27ae60;} .poort{border-left-color:#8e44ad;}
.verwijder-btn{position:absolute;top:10px;right:10px;background:#c0392b;font-size:12px;padding:5px 8px;}
.photos{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
.photos img{width:90px;border-radius:6px;border:1px solid #ccc;}
#cameraModal{display:none;position:fixed;top:0;left:0;width:100vw;height:calc(var(--vh)*100);background:rgba(0,0,0,0.95);z-index:1000;overflow:hidden;}
#cameraModal video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
#cameraModal button{position:absolute;z-index:1010;padding:12px 18px;border-radius:6px;border:none;background:rgba(15,36,65,0.85);color:white;font-size:16px;}
#takePhotoBtn{bottom:30px;left:50%;transform:translateX(-50%);}
#closeCameraBtn{top:20px;right:20px;}
</style>
</head>
<body>

<header>
<img src="Logordb.png" alt="Logo">
<h1>Nieuwe Opmeting</h1>
<button onclick="nieuwProject()">Nieuw Project</button>
</header>

<input type="text" id="klant" placeholder="Naam klant">

<h3>Kamer kiezen</h3>
<select id="kamer">
<option>Slaapkamer</option>
<option>Badkamer</option>
<option>Keuken</option>
<option>Living</option>
<option>Garage</option>
<option>Eetplaats</option>
<option>Gang</option>
<option>Toilet</option>
<option>Ander</option>
</select>

<h3>Kies element</h3>
<select id="elementType">
<option value="Raam">Raam</option>
<option value="Deur">Deur</option>
<option value="Poort">Poort</option>
</select>

<button onclick="voegElementToe()">Toevoegen</button>

<div id="lijst"></div>

<button onclick="maakPDF()">Project als PDF</button>
<button id="mailBtn" onclick="mailProject()" disabled>Project mailen</button>

<p id="mailInstructie" style="display:none;">Open het gedownloade PDF-bestand via je bestanden-app om het bij te voegen in Mail.</p>

<!-- CAMERA -->
<div id="cameraModal">
<video id="video" autoplay playsinline></video>
<button id="takePhotoBtn" onclick="takePhoto()">Foto maken</button>
<button id="closeCameraBtn" onclick="closeCamera()">Sluiten</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
function setRealViewportHeight(){ const vh = window.innerHeight*0.01; document.documentElement.style.setProperty('--vh',`${vh}px`);}
window.addEventListener('resize',setRealViewportHeight);
window.addEventListener('load',setRealViewportHeight);

let project = JSON.parse(localStorage.getItem("project"))||{klant:"",elementen:[]};
let fotosMemory = {};
let currentElementId = null;
let pdfGemaakt = false;

function saveMetadata(){ localStorage.setItem("project",JSON.stringify(project)); }
function nieuwProject(){ if(confirm("Nieuw project starten? Alles wordt gewist.")){ localStorage.removeItem("project"); location.reload(); }}
function voegElementToe(){
    const type=document.getElementById("elementType").value;
    const kamer=document.getElementById("kamer").value;
    const nieuw={id:Date.now(),type:type,kamer:kamer,breedte:"",hoogte:"",notitie:""};
    project.elementen.unshift(nieuw);
    fotosMemory[nieuw.id]=[];
    saveMetadata();
    render();
}

function render(){
    document.getElementById("klant").value=project.klant;
    const lijst=document.getElementById("lijst");
    lijst.innerHTML="";
    let typeCount={Raam:0,Deur:0,Poort:0};
    let nummering={};
    const reversed=[...project.elementen].reverse();
    reversed.forEach(el=>{ typeCount[el.type]++; nummering[el.id]=typeCount[el.type]; });

    project.elementen.forEach(el=>{
        const nummer=nummering[el.id];
        if(!fotosMemory[el.id]) fotosMemory[el.id]=[];
        const div=document.createElement("div");
        div.className="element";
        div.innerHTML=`
            <button class="verwijder-btn" onclick="verwijderElement(${el.id})">Element verwijderen</button>
            <strong>${el.type} ${nummer} - ${el.kamer}</strong><br>
            Breedte (cm):
            <input value="${el.breedte}" onchange="update(${el.id},'breedte',this.value)">
            Hoogte (cm):
            <input value="${el.hoogte}" onchange="update(${el.id},'hoogte',this.value)">
            Notitie:
            <textarea onchange="update(${el.id},'notitie',this.value)">${el.notitie}</textarea>
            <button onclick="openCamera(${el.id})">Foto nemen</button>
            <div class="photos">
                ${fotosMemory[el.id].map((f,i)=>`
                    <div style="position:relative;">
                        <img src="${f}">
                        <button style="position:absolute;top:-6px;right:-6px;background:#2980b9;border:none;color:white;font-size:12px;width:20px;height:20px;border-radius:50%;cursor:pointer;" onclick="verwijderFoto(${el.id},${i})">Ã—</button>
                    </div>
                `).join("")}
            </div>
        `;
        lijst.appendChild(div);
    });
}

function update(id,veld,waarde){ const el=project.elementen.find(e=>e.id===id); el[veld]=waarde; saveMetadata();}
function verwijderFoto(id,index){ fotosMemory[id].splice(index,1); render();}
function verwijderElement(id){ if(confirm("Element verwijderen?")){ project.elementen=project.elementen.filter(e=>e.id!==id); delete fotosMemory[id]; saveMetadata(); render();}}

async function openCamera(id){ currentElementId=id; cameraModal.style.display="block"; try{ const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}}); video.srcObject=stream;}catch(err){alert("Camera niet beschikbaar");}}
function takePhoto(){ const ctx=canvas.getContext("2d"); canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0); const data=canvas.toDataURL("image/jpeg",0.6); fotosMemory[currentElementId].push(data); closeCamera(); setTimeout(render,150);}
function closeCamera(){ cameraModal.style.display="none"; if(video.srcObject) video.srcObject.getTracks().forEach(track=>track.stop());}

/* ===== PDF met 6D coverpagina + partnerlogo's + alle foto's correct ===== */
function loadImagePromise(src){
    return new Promise((resolve)=>{
        const img = new Image();
        img.src = src;
        img.onload = ()=>resolve(img);
    });
}

async function maakPDF() {

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setTextColor(0, 0, 0); // Alles zwart

    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    const margin = 15;
    const bottomMargin = 20;

    let y = 20;

    // ==============================
    // HELPER OM AFBEELDINGEN TE LADEN
    // ==============================

    function loadImagePromise(src){
        return new Promise((resolve)=>{
            const img = new Image();
            img.src = src;
            img.onload = ()=>resolve(img);
        });
    }

    // ==============================
    // COVER HEADER
    // ==============================

    const logo = await loadImagePromise('logordb.png');
    const logoWidth = 40;
    const logoHeight = logoWidth / (logo.width / logo.height);

    doc.addImage(logo, 'PNG', margin, 10, logoWidth, logoHeight);

    doc.setFontSize(11);
    doc.text("RDB Ramen & Deuren", margin + 45, 15);
    doc.text("info@rdbramen.be", margin + 45, 21);
    doc.text("0470 00 00 00", margin + 45, 27);
    doc.text("BTW BE0000.000.000", margin + 45, 33);

    doc.setFontSize(12);
    doc.text(`Datum: ${new Date().toLocaleDateString()}`, pageWidth - 60, 15);

    // Partnerlogo's
    const reynaersLogo = await loadImagePromise('reynaers.png');
    const gealanLogo = await loadImagePromise('gealan.png');

    const partnerWidth = 35;
    let partnerY = 22;

    let h1 = partnerWidth / (reynaersLogo.width / reynaersLogo.height);
    doc.addImage(reynaersLogo, 'PNG', pageWidth - 50, partnerY, partnerWidth, h1);

    let h2 = partnerWidth / (gealanLogo.width / gealanLogo.height);
    doc.addImage(gealanLogo, 'PNG', pageWidth - 50, partnerY + 18, partnerWidth, h2);

    y = 50;

    doc.setFontSize(18);
    doc.text("Overzicht aantal elementen", margin, y);
    y += 12;

    doc.setFontSize(12);

    // ==============================
    // ELEMENTEN
    // ==============================

    for (const el of elementen) {

        const fotoMaxWidth = 70;
        const textX = margin + fotoMaxWidth + 10;
        const textWidth = pageWidth - textX - margin;

        let imgHeight = 0;
        let img = null;

        if (el.foto) {
            img = await loadImagePromise(el.foto);
            const ratio = img.width / img.height;
            imgHeight = fotoMaxWidth / ratio;
        }

        const lineHeight = 6;
        let textLines = 4;

        if (el.notitie) {
            const splitNote = doc.splitTextToSize(el.notitie, textWidth);
            textLines += splitNote.length;
        }

        const textHeight = textLines * lineHeight;

        const blockHeight = Math.max(imgHeight, textHeight) + 12;

        // PAGINACONTROLE
        if (y + blockHeight > pageHeight - bottomMargin) {
            doc.addPage();
            y = 20;
        }

        // Lichte scheidingslijn boven element
        doc.setLineWidth(0.2);
        doc.line(margin, y - 5, pageWidth - margin, y - 5);

        // FOTO LINKS
        if (img) {
            doc.addImage(img, 'JPEG', margin, y, fotoMaxWidth, imgHeight);
        }

        // TEKST RECHTS
        let textY = y;

        doc.text(`Ruimte: ${el.ruimte}`, textX, textY);
        textY += lineHeight;

        doc.text(`Breedte: ${el.breedte} mm`, textX, textY);
        textY += lineHeight;

        doc.text(`Hoogte: ${el.hoogte} mm`, textX, textY);
        textY += lineHeight;

        if (el.notitie) {
            const splitNote = doc.splitTextToSize(el.notitie, textWidth);
            doc.text(splitNote, textX, textY);
        }

        y += blockHeight;
    }

    // ==============================
    // PAGINANUMMERING
    // ==============================

    const pageCount = doc.getNumberOfPages();

    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.text(
            `Pagina ${i} van ${pageCount}`,
            pageWidth / 2,
            pageHeight - 10,
            { align: "center" }
        );
    }

    doc.save("opmeting.pdf");
}


    // --- Footer ---
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text("Leopoldlaan 91 9900 Eeklo - Tel 09/343.82.70 - info@ramen-blondeel.be",105,290,{align:"center"});

    const fileName=`${project.klant.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    pdfGemaakt=true;
    document.getElementById("mailBtn").disabled=false;
    alert("PDF opgeslagen. Nu kan je project mailen.");
}

function mailProject(){ 
    if(!pdfGemaakt){ alert("Maak eerst de PDF."); return;}
    const subject=encodeURIComponent(`Nieuwe Opmeting: ${project.klant}`);
    const body=encodeURIComponent(`Zie bijlage voor het project: ${project.klant}`);
    window.location.href=`mailto:?subject=${subject}&body=${body}`;
}

document.getElementById("klant").addEventListener("input",e=>{ project.klant=e.target.value; saveMetadata();});
render();
</script>
</body>
</html>

