<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Werf Rapport</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial; margin: 20px; }
button { margin: 5px; padding: 10px; }
.element { margin-top: 15px; padding: 10px; border: 1px solid #ccc; }
img { max-width: 150px; margin: 5px; }
</style>
</head>
<body>

<h2>Werf Rapport</h2>

<label>Klantnaam:</label>
<input type="text" id="klantnaam"><br><br>

<button onclick="addElement('raam')">Raam toevoegen</button>
<button onclick="addElement('deur')">Deur toevoegen</button>
<button onclick="addElement('poort')">Poort toevoegen</button>

<div id="elements"></div>

<br>
<button onclick="generatePDF()">Genereer PDF</button>

<script>

let elements = [];

function addElement(type) {
    elements.unshift({
        type: type,
        photos: []
    });
    renderElements();
}

function renderElements() {
    const container = document.getElementById("elements");
    container.innerHTML = "";

    elements.forEach((el, index) => {
        const div = document.createElement("div");
        div.className = "element";

        div.innerHTML = `
            <strong>${el.type.toUpperCase()}</strong><br>
            <input type="file" accept="image/*" multiple onchange="handleUpload(event, ${index})"><br>
        `;

        el.photos.forEach(photo => {
            const img = document.createElement("img");
            img.src = photo;
            div.appendChild(img);
        });

        container.appendChild(div);
    });
}

function compressImage(file, maxWidth = 900, quality = 0.6) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = height * ratio;
                }

                const canvas = document.createElement("canvas");
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(blob => {
                    const reader2 = new FileReader();
                    reader2.onloadend = () => resolve(reader2.result);
                    reader2.readAsDataURL(blob);
                }, "image/jpeg", quality);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

async function handleUpload(event, index) {
    const files = event.target.files;

    for (let file of files) {
        const compressed = await compressImage(file);
        elements[index].photos.push(compressed);
    }

    renderElements();
}

function getPlural(type, count) {
    if (type === "raam") return count > 1 ? "ramen" : "raam";
    if (type === "deur") return count > 1 ? "deuren" : "deur";
    if (type === "poort") return count > 1 ? "poorten" : "poort";
}

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const klant = document.getElementById("klantnaam").value;

    doc.setFontSize(18);
    doc.text("WERF RAPPORT", 20, 20);

    doc.setFontSize(12);
    doc.text("Klant: " + klant, 20, 30);

    let y = 40;

    // Overzicht
    const counts = {};

    elements.forEach(el => {
        counts[el.type] = (counts[el.type] || 0) + 1;
    });

    Object.keys(counts).forEach(type => {
        if (counts[type] > 0) {
            doc.text("Aantal " + getPlural(type, counts[type]) + ": " + counts[type], 20, y);
            y += 8;
        }
    });

    y += 10;

    // Foto's
    elements.forEach(el => {
        el.photos.forEach(photo => {
            if (y > 260) {
                doc.addPage();
                y = 20;
            }

            doc.addImage(photo, "JPEG", 20, y, 170, 0);
            y += 60;
        });
    });

    doc.save("werf_rapport.pdf");
}

</script>
</body>
</html>

